<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ChatGPT Style - Dify RAG Chatbot (Markdown Version)</title>

  <!-- Marked.js (Markdown Parser) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Highlight.js (Code Syntax Highlighter) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

  <style>
    body {
      background: #f5f5f7;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
    }

    #container {
      width: 100%;
      max-width: 700px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .msg.user {
      align-self: flex-end;
      background: #007bff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg.bot {
      align-self: flex-start;
      background: #e9e9eb;
      color: #222;
      border-bottom-left-radius: 4px;
    }

    .time {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
      text-align: right;
    }

    #inputArea {
      padding: 10px;
      background: white;
      border-top: 1px solid #ccc;
      display: flex;
      gap: 10px;
    }

    textarea {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      resize: none;
      height: 60px;
    }

    button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background: #10a37f;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    /* 로딩 애니메이션 */
    .loading-container {
      display: flex;
      gap: 6px;
      padding: 12px;
      background: #e9e9eb;
      align-self: flex-start;
      border-radius: 12px;
    }

    .loading {
      width: 6px;
      height: 6px;
      background: #555;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }

    /* Markdown 스타일 보완 */
    .msg.bot h1, .msg.bot h2, .msg.bot h3 {
      margin: 8px 0 4px;
    }

    .msg.bot pre {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
    }

  </style>
</head>

<body>

<div id="container">
  
  <div id="chat"></div>

  <div id="inputArea">
    <textarea id="input" placeholder="질문을 입력하세요… (Enter: 전송, Shift+Enter: 줄바꿈)"></textarea>
    <button onclick="send()">전송</button>
  </div>

</div>

<script>
const API_KEY = "app-rNcQlKfaFqtl6885g7EIQPZN"; 
const CHAT_URL = "https://api.dify.ai/v1/chat-messages";

document.getElementById("input").addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

function getTime(){
  const now = new Date();
  return now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
}

async function send(){
  const text = document.getElementById("input").value.trim();
  if(!text) return;

  addUser(text);
  document.getElementById("input").value = "";

  const loader = addLoading();

  const res = await fetch(CHAT_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${API_KEY}`
    },
    body: JSON.stringify({
      query: text,
      user: "user1",
      response_mode: "blocking",
      inputs: {}
    })
  });

  loader.remove();

  const data = await res.json();
  addBot(data.answer);
}

/* 사용자 메시지 */
function addUser(text){
  const chat = document.getElementById("chat");
  chat.innerHTML += `
    <div class="msg user">${text}<div class="time">${getTime()}</div></div>
  `;
  chat.scrollTop = chat.scrollHeight;
}

/* 봇 메시지 + Markdown 렌더링 */
function addBot(text){
  const chat = document.getElementById("chat");

  const html = marked.parse(text);
  
  const div = document.createElement("div");
  div.className = "msg bot";
  div.innerHTML = html + `<div class="time">${getTime()}</div>`;

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  // 코드 하이라이트 적용
  div.querySelectorAll("pre code").forEach((block) => {
    hljs.highlightElement(block);
  });
}

function addLoading(){
  const chat = document.getElementById("chat");
  const div = document.createElement("div");

  div.className = "loading-container";
  div.innerHTML = `
    <div class="loading"></div>
    <div class="loading"></div>
    <div class="loading"></div>
  `;

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}
</script>

</body>
</html>
